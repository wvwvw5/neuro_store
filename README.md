# Магазин подписок на нейросети (Neuro Store)

> Учебный курсовой проект: защищённая клиент-серверная система для продажи подписок на нейросетевые сервисы. Backend: **FastAPI + PostgreSQL + SQLAlchemy/Alembic**, Frontend: **Next.js (React)**, DevOps: **Docker Compose**.

---

## Содержание

* [Быстрый старт](#быстрый-старт)
* [Локальный запуск без Docker](#локальный-запуск-без-docker)
* [Архитектура базы данных](#архитектура-базы-данных)
* [Миграции БД (Alembic)](#миграции-бд-alembic)
* [Скрипты бэкапа/восстановления](#скрипты-бэкапавосстановления)
* [Дорожная карта](#дорожная-карта)
* [Стандарты разработки](#стандарты-разработки)

---

## Быстрый старт

### Запуск через Docker Compose (рекомендуется)

1. **Поднимите сервисы:**
```bash
docker compose -f ops/docker-compose.yml up --build
```

2. **Доступные сервисы:**
* **Backend (FastAPI):** http://localhost:8000
* **Swagger UI:** http://localhost:8000/docs
* **PostgreSQL:** localhost:5432
* **pgAdmin:** http://localhost:5050
* **Frontend (Next.js):** http://localhost:3000

3. **Примените миграции:**
```bash
docker compose exec backend alembic upgrade head
```

---

## Локальный запуск без Docker

### Backend

```bash
# 1. Виртуальное окружение и зависимости
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 2. Переменные окружения
cp ops/.env.example .env

# 3. Миграции
alembic upgrade head

# 4. Запуск сервера
uvicorn app.main:app --reload
# Swagger UI: http://127.0.0.1:8000/docs
```

### Frontend

```bash
cd client
npm install
npm run dev
# http://localhost:3000
```

---

## Архитектура базы данных

### Основные сущности (11 таблиц)

1. **users** - Пользователи системы
2. **roles** - Роли пользователей  
3. **user_roles** - Связь пользователей и ролей (M:M)
4. **products** - Продукты (нейросети)
5. **plans** - Тарифные планы
6. **product_plans** - Связь продуктов и планов (M:M)
7. **subscriptions** - Подписки пользователей
8. **orders** - Заказы
9. **payments** - Платежи
10. **usage_events** - События использования
11. **audit_log** - Журнал аудита

### Типы связей

- **1:1** - Заказ ↔ Платеж
- **1:M** - Пользователь → Подписки, Продукт → Связи с планами
- **M:M** - Пользователи ↔ Роли, Продукты ↔ Планы (через промежуточные таблицы)

### Нормализация

Все таблицы находятся в 3НФ (третьей нормальной форме) с устранением транзитивных зависимостей.

## Структура файлов

```
neuro_store/
├── docs/
│   └── erd.md          # ER-диаграмма и словарь данных
├── db/
│   ├── ddl.sql         # SQL-скрипт создания таблиц
│   └── triggers.sql    # Триггеры, функции и процедуры
├── ops/
│   ├── docker-compose.yml  # Docker Compose конфигурация
│   └── .env.example        # Пример переменных окружения
├── app/                     # FastAPI приложение
├── client/                  # Next.js frontend
├── requirements.txt         # Python зависимости
└── README.md               # Документация проекта
```

## Установка и настройка

### Требования

- **Backend:** Python 3.8+, FastAPI, PostgreSQL 14+
- **Frontend:** Node.js 16+, Next.js
- **DevOps:** Docker, Docker Compose
- **Расширение `pg_cron`** (опционально, для автоматических задач)

### Шаги установки

1. **Создание базы данных:**
```sql
CREATE DATABASE neuro_store;
\c neuro_store;
```

2. **Выполнение DDL скрипта:**
```bash
psql -d neuro_store -f db/ddl.sql
```

3. **Выполнение скрипта с триггерами:**
```bash
psql -d neuro_store -f db/triggers.sql
```

4. **Проверка установки:**
```sql
-- Проверка таблиц
\dt

-- Проверка функций
\df

-- Проверка представлений
\dv

-- Проверка целостности данных
SELECT * FROM check_data_integrity();
```

## Основной функционал

### Аудит и логирование

- **Триггеры аудита** на все основные таблицы
- **Автоматическое логирование** INSERT/UPDATE/DELETE операций
- **Журнал изменений** с сохранением старых и новых значений
- **Отслеживание пользователей**, выполняющих операции

### Управление подписками

- **Процедура активации** подписок с транзакциями
- **Автоматическое обновление** статуса истекших подписок
- **Проверка статуса** и деталей подписки
- **Статистика пользователя** по подпискам

### Аналитика и отчеты

- **VIEW для активных подписок** с детальной информацией
- **Отчет по выручке** по месяцам, продуктам и планам
- **Статистика использования** нейросетей
- **Мониторинг аудита** в реальном времени

### Безопасность и целостность

- **Ограничения целостности** (CHECK, FOREIGN KEY)
- **ON DELETE RESTRICT** для защиты от случайного удаления
- **ON UPDATE CASCADE** для синхронизации изменений
- **Проверка целостности данных** через функции

## Примеры использования

### Активация подписки

```sql
-- Установка текущего пользователя
SELECT set_current_user(1);

-- Активация подписки по заказу
CALL activate_subscription(1);
```

### Проверка статуса подписки

```sql
-- Получение детальной информации о подписке
SELECT * FROM check_subscription_status(1);
```

### Получение статистики пользователя

```sql
-- Статистика по подпискам и тратам
SELECT * FROM get_user_statistics(1);
```

### Аналитические отчеты

```sql
-- Активные подписки
SELECT * FROM active_subscriptions_report;

-- Выручка по месяцам
SELECT * FROM revenue_report;

-- Статистика использования
SELECT * FROM usage_statistics;
```

### Аудит и мониторинг

```sql
-- Отчет по аудиту
SELECT * FROM get_audit_report('subscriptions', 'UPDATE');

-- Мониторинг активности
SELECT * FROM audit_monitoring;

-- Проверка целостности
SELECT * FROM check_data_integrity();
```

## Автоматические задачи

### Обновление статуса подписок

```sql
-- Ручной запуск
SELECT update_expired_subscriptions();

-- Автоматический запуск (если pg_cron установлен)
SELECT cron.schedule('update-expired-subscriptions', '0 2 * * *', 
    'SELECT update_expired_subscriptions();');
```

### Очистка старых записей аудита

```sql
-- Очистка записей старше 12 месяцев
SELECT cleanup_old_audit_logs(12);

-- Автоматическая очистка (если pg_cron установлен)
SELECT cron.schedule('cleanup-audit-logs', '0 3 1 * *', 
    'SELECT cleanup_old_audit_logs(12);');
```

## Миграции БД (Alembic)

```bash
# Создать ревизию
alembic revision -m "init schema"

# Применить миграции
alembic upgrade head

# Откатить миграцию
alembic downgrade -1
```

## Скрипты бэкапа/восстановления

### Бэкап:

```bash
# В Docker
docker compose exec db pg_dump -U $POSTGRES_USER -d $POSTGRES_DB > db/backup/backup_$(date +%F).sql
```

### Восстановление:

```bash
# В Docker
docker compose exec -T db psql -U $POSTGRES_USER -d $POSTGRES_DB < db/restore/dump.sql
```

## Индексы и производительность

### Созданные индексы

- **Первичные ключи** (автоматически)
- **Внешние ключи** для быстрого JOIN
- **Часто используемые поля** (статусы, даты, email)
- **Составные индексы** для сложных запросов

### Оптимизация запросов

- **VIEW для сложных отчетов**
- **Индексы по условиям WHERE**
- **Оптимизированные JOIN** через промежуточные таблицы

## Безопасность

### Роли и права доступа

- **admin** - Полный доступ к системе
- **moderator** - Модерация контента
- **user** - Обычный пользователь

### Аудит операций

- **Логирование всех изменений**
- **Отслеживание пользователей**
- **Сохранение истории изменений**

## Расширение функционала

### Добавление новых нейросетей

```sql
-- Добавление нового продукта
INSERT INTO products (name, description, category) VALUES 
('Claude', 'AI-ассистент от Anthropic', 'Языковые модели');

-- Связывание с планами
INSERT INTO product_plans (product_id, plan_id) VALUES 
(6, 1), (6, 2), (6, 3), (6, 4);
```

### Создание новых тарифных планов

```sql
-- Добавление нового плана
INSERT INTO plans (name, description, price, duration_days) VALUES 
('Пробный', 'Пробный доступ на 7 дней', 0.00, 7);
```

## Мониторинг и обслуживание

### Регулярные задачи

1. **Ежедневно в 2:00** - Обновление статуса истекших подписок
2. **Ежемесячно в 3:00** - Очистка старых записей аудита
3. **Еженедельно** - Проверка целостности данных

### Рекомендации по производительности

- **Мониторинг размера таблиц** (особенно audit_log)
- **Анализ медленных запросов** через pg_stat_statements
- **Регулярная очистка** старых записей аудита
- **Партиционирование** больших таблиц при необходимости

## Дорожная карта

| Этап              | Подзадачи                                                            | Статус |
| ----------------- | -------------------------------------------------------------------- | ------ |
| 1. Инициализация | README, структура проекта, Docker, pgAdmin                           | ✅      |
| 2. БД            | ERD, DDL (ddl.sql), триггеры/процедуры, Alembic                      | ✅      |
| 3. Backend API   | Аутентификация (JWT), RBAC, CRUD: products, plans, subscriptions ... | ⏳      |
| 4. Клиент        | UI: личный кабинет, подписки, аналитика                              | ⏳      |
| 5. Тестирование  | Pytest, интеграционные тесты, линтеры                                | ⏳      |
| 6. Документация  | OpenAPI, инструкции, отчёт по КП                                     | ⏳      |

## Стандарты разработки

* **Коммиты:** Conventional Commits (`feat:`, `fix:`, `docs:`, `refactor:` ...)
* **Ветки:** `main`, `develop`, фичи --- `feature/<task>`
* **Код-стайл:** `ruff`, `black`, `isort`, `mypy`
* **PR:** использование шаблона с чек-листом (линтеры, тесты, обновление docs)

## Поддержка и развитие

### Возможные улучшения

- **API endpoints** для интеграции с frontend
- **Микросервисная архитектура** для масштабирования
- **Кэширование** часто запрашиваемых данных
- **Асинхронная обработка** платежей и уведомлений

### Тестирование

- **Unit тесты** для функций и процедур
- **Интеграционные тесты** для триггеров
- **Нагрузочное тестирование** для оптимизации

## Заключение

Данная система предоставляет полнофункциональный backend для магазина подписок на нейросети, соответствующий всем требованиям курсового проекта:

✅ **11 таблиц в 3НФ**  
✅ **Связи 1:1, 1:M, M:M**  
✅ **Ограничения целостности**  
✅ **Процедуры и функции**  
✅ **Триггеры аудита**  
✅ **Транзакции**  
✅ **Аналитика через VIEW**  
✅ **FastAPI + Next.js архитектура**  
✅ **Docker Compose развертывание**  
✅ **Полная документация**  

Система готова к использованию и дальнейшему развитию!

---

## About

Проект создан в рамках курсовой работы по разработке защищённой клиент-серверной системы для продажи подписок на нейросетевые сервисы.
