name: CI Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.11"]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: neuro_store_test
          POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d neuro_store_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 10s
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ’¾ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client redis-tools

    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install fakeredis[aioredis]  # Ğ¯Ğ²Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ fakeredis Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²

    - name: â³ Wait for PostgreSQL to be ready
      run: |
        echo "Waiting for PostgreSQL to be ready..."
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "âœ… PostgreSQL is ready!"
            break
          fi
          echo "â³ Attempt $i/30: PostgreSQL not ready yet, waiting..."
          sleep 2
        done
        
        # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
        if ! pg_isready -h localhost -p 5432 -U postgres; then
          echo "âŒ PostgreSQL failed to start"
          exit 1
        fi

    - name: â³ Wait for Redis to be ready
      run: |
        echo "Waiting for Redis to be ready..."
        for i in {1..15}; do
          if redis-cli -h localhost -p 6379 ping; then
            echo "âœ… Redis is ready!"
            break
          fi
          echo "â³ Attempt $i/15: Redis not ready yet, waiting..."
          sleep 2
        done
        
        # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
        if ! redis-cli -h localhost -p 6379 ping; then
          echo "âŒ Redis failed to start"
          exit 1
        fi

    - name: ğŸ—„ï¸ Create test database
      run: |
        echo "Creating test database..."
        PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE neuro_store_test;" || echo "Database may already exist"
        PGPASSWORD=postgres psql -h localhost -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE neuro_store_test TO postgres;"

    - name: ğŸ”„ Run database migrations
      run: |
        echo "Running Alembic migrations..."
        cd app
        alembic upgrade head
      env:
        DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/neuro_store_test
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET: test_jwt_secret_for_ci_only_min_32_chars_long_enough
        SECRET_KEY: test_secret_key_for_ci_only_min_32_chars_long_enough
        APP_ENV: test
        LOG_LEVEL: WARNING

    - name: ğŸ§ª Run tests
      run: |
        echo "Running pytest with coverage..."
        pytest -q --disable-warnings --maxfail=1 --cov=app --cov-report=xml --cov-report=html --junitxml=junit.xml -v
      env:
        APP_ENV: test
        LOG_LEVEL: WARNING
        DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/neuro_store_test
        TEST_DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/neuro_store_test
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET: test_jwt_secret_for_ci_only_min_32_chars_long_enough
        SECRET_KEY: test_secret_key_for_ci_only_min_32_chars_long_enough
        ACCESS_TOKEN_EXPIRE_MINUTES: 60
        JWT_EXPIRE_MINUTES: 60
        ALGORITHM: HS256
        CORS_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
        PROJECT_NAME: Neuro Store API Test
        PROJECT_VERSION: 1.0.0-test
        PROJECT_DESCRIPTION: Test API Ğ´Ğ»Ñ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº Ğ½Ğ° Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ĞµĞ²Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
        CACHE_TTL_SECONDS: 60
        CACHE_TTL_PRODUCTS: 120
        CACHE_TTL_PLANS: 180
        RATE_LIMIT_DEFAULT: 100/minute
        RATE_LIMIT_LOGIN: 20/minute
        RATE_LIMIT_REGISTER: 10/minute
        RATE_LIMIT_PRODUCTS: 100/minute
        RATE_LIMIT_SUBSCRIPTIONS: 50/minute

    - name: ğŸ“Š Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: ./coverage.xml
        flags: unittests
        name: neuro-store-coverage
        fail_ci_if_error: false

    - name: ğŸ“‹ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          junit.xml
          htmlcov/
          coverage.xml
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ“ Upload test logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-logs-python-${{ matrix.python-version }}
        path: |
          app/*.log
          tests/*.log
          pytest.log
          .pytest_cache/
        retention-days: 7
        if-no-files-found: warn

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ’¾ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-lint-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-lint-

    - name: ğŸ”§ Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff black isort mypy types-redis

    - name: ğŸ” Run ruff linter
      run: |
        echo "Running ruff..."
        ruff check app/ tests/ || exit 1

    - name: ğŸ¨ Check black formatting
      run: |
        echo "Checking black formatting..."
        black --check app/ tests/ || exit 1

    - name: ğŸ“¦ Check isort imports
      run: |
        echo "Checking isort imports..."
        isort --check-only app/ tests/ || exit 1

    - name: ğŸ”¬ Run mypy type checking
      run: |
        echo "Running mypy..."
        mypy app/ || exit 0  # ĞĞµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ CI Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ÑÑ… mypy

  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '0'
        ignore-unfixed: true

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ” Run safety check for Python dependencies
      run: |
        pip install safety
        safety check --json --output safety-report.json || echo "Safety check completed with warnings"
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½
        if [ -f safety-report.json ]; then
          echo "âœ… Safety report generated successfully"
        else
          echo "âš ï¸ Safety report not generated, creating empty report"
          echo '{"vulnerabilities": []}' > safety-report.json
        fi

    - name: ğŸ“‹ Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          trivy-results.sarif
          safety-report.json
        retention-days: 30
        if-no-files-found: warn

  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”¨ Test backend Docker build
      run: |
        echo "Testing backend Docker build..."
        docker build -f ops/Dockerfile.backend --target development -t neuro-store-backend-test .

    - name: ğŸ”¨ Test frontend Docker build
      run: |
        echo "Testing frontend Docker build..."
        docker build -f ops/Dockerfile.frontend --target development -t neuro-store-frontend-test ./client

    - name: ğŸ§ª Test Docker Compose
      run: |
        echo "Testing Docker Compose configuration..."
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ, Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
        docker compose -f ops/docker-compose.yml config

  notify:
    runs-on: ubuntu-latest
    needs: [test, lint, security, build-test]
    if: always()
    
    steps:
    - name: ğŸ“Š Check test results
      run: |
        echo "=== CI PIPELINE RESULTS ==="
        echo "Tests: ${{ needs.test.result }}"
        echo "Linting: ${{ needs.lint.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Build: ${{ needs.build-test.result }}"
        echo "=========================="
        
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.lint.result }}" == "success" ]]; then
          echo "âœ… All critical checks passed!"
        else
          echo "âŒ Some critical checks failed!"
          exit 1
        fi